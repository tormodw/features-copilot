# Home Automation System

A modular, event-driven C++ system for home automation based on multiple sensor inputs, energy cost optimization, and **machine learning-based day-ahead scheduling**.

## Features

### Sensor Integration
- **Energy Meters**: Monitor real-time energy consumption
- **Temperature Sensors**: Indoor and outdoor temperature monitoring
- **Solar Production Sensors**: Track solar panel energy production
- **EV Charger Sensors**: Monitor electric vehicle charging status

### Communication Protocol
- **MQTT Integration**: Real-time communication with sensors and appliances
- **Home Assistant MQTT Integration**: Bidirectional data exchange with Home Assistant
  - Fetch sensor data FROM HA via MQTT subscribe
  - **Publish local sensor states TO HA/MQTT** for monitoring and automation
  - Execute commands TO HA via MQTT publish
  - Support for HA MQTT discovery protocol
- **HTTP API**: Fetch hourly energy costs from external services

### Appliance Control
The system manages various appliances intelligently:
- **Heaters**: Automatic temperature control
- **Air Conditioners**: Cooling based on temperature and energy cost
- **Lights**: Brightness adjustment for energy savings
- **Curtains**: Passive temperature management
- **EV Chargers**: Smart charging based on energy costs and solar production

### Decision-Making Logic
The energy optimizer minimizes energy consumption while maintaining user comfort:
1. **Cost-based optimization**: Stop/adjust operations during high electricity costs
2. **Solar utilization**: Leverage solar production for usage planning
3. **Temperature maintenance**: Ensure efficient heating/cooling
4. **Passive strategies**: Use curtains for thermal management

### Machine Learning Day-Ahead Optimization
**NEW**: The system now includes ML-based predictive optimization:
- **Historical Data Learning**: Trains on 30+ days of energy cost, solar production, and temperature patterns
- **24-Hour Forecasting**: Predicts next day's energy costs, solar availability, and weather
- **Optimal Scheduling**: Generates hourly schedule to minimize costs while maintaining comfort
- **Smart EV Charging**: Identifies the 4 best hours for charging (lowest cost, highest solar)
- **Pre-heating/Cooling**: Conditions home during low-cost hours to reduce peak-hour usage
- **Cost Estimation**: Provides estimated daily energy cost and consumption

### Deferrable Load Control
**NEW**: Intelligent control of non-critical loads based on price and historical patterns:
- **Price Threshold Control**: Automatically switch off deferrable loads when prices exceed threshold
- **Busy Hour Detection**: Analyze historical data to identify high-price periods
- **Load Classification**: Mark appliances as deferrable (EV chargers, decorative lights) or critical (HVAC, essential lighting)
- **Day-Ahead Recommendations**: Generate 24-hour schedule for deferrable load operation
- **State Management**: Intelligently resume loads when conditions improve
- **Cost Savings**: Achieve 10-20% reduction in energy costs without compromising comfort

### Continuous ML Training
**NEW**: System continuously learns and improves from operational data:
- **Automatic Data Collection**: Continuously collect temperature, solar, and energy cost data
- **Scheduled Retraining**: Automatically retrain ML model on configurable schedule (default: daily)
- **Data Persistence**: Historical data saved to file and survives system restarts
- **Retention Management**: Automatic cleanup of old data (configurable, default: 90 days)
- **Adaptive Learning**: Model improves over time by learning from actual usage patterns
- **No Manual Intervention**: Fully automatic operation with minimal configuration

## Architecture

### Event-Driven Design
- **EventManager**: Central event bus for component communication
- **Event Types**: Temperature changes, energy updates, cost updates, etc.
- **Subscribers**: Components subscribe to relevant events

### Modular Structure
```
include/
├── Event.h                      - Event data structure
├── EventManager.h               - Event distribution system
├── Sensor.h                     - Base sensor class
├── Appliance.h                  - Base appliance class (with deferrable support)
├── MQTTClient.h                 - MQTT communication
├── HAIntegration.h              - Home Assistant MQTT integration
├── HTTPClient.h                 - HTTP API client
├── EnergyOptimizer.h            - Real-time decision-making logic
├── MLPredictor.h                - ML-based forecasting engine
├── DayAheadOptimizer.h          - Predictive scheduling optimizer
├── DeferrableLoadController.h   - Deferrable load management
├── HistoricalDataCollector.h   - Continuous data collection
├── MLTrainingScheduler.h        - Automatic ML retraining
├── HistoricalDataGenerator.h   - Training data generation
├── Sensors/
│   ├── TemperatureSensor.h
│   ├── EnergyMeter.h
│   ├── SolarSensor.h
│   └── EVChargerSensor.h
└── Appliances/
    ├── Heater.h
    ├── AirConditioner.h
    ├── Light.h
    ├── Curtain.h
    └── EVCharger.h
```

## Building the Project

### Prerequisites
- CMake 3.10 or higher
- C++17 compatible compiler (GCC 7+, Clang 5+, MSVC 2017+)

### Build Instructions

```bash
# Create build directory
mkdir build
cd build

# Configure and build
cmake ..
make

# Run the application
./home_automation
```

## Usage Example

The system automatically:
1. **Trains ML model** on historical energy data (30 days)
2. **Generates day-ahead schedule** predicting optimal appliance usage for next 24 hours
3. **Monitors sensor inputs** via MQTT in real-time
4. **Fetches current energy costs** from HTTP API
5. **Makes intelligent decisions** to optimize energy usage
6. **Controls appliances** based on:
   - Day-ahead schedule recommendations
   - Current energy cost
   - Solar production levels
   - Indoor/outdoor temperatures
   - User comfort requirements

### Example Scenarios

**Scenario 1: ML Day-Ahead Optimization**
- ML predicts energy costs will be high from 7am-10pm
- System schedules EV charging for 4 optimal hours (10am-1pm when solar is high)
- Preheats home during low-cost night hours (0am-6am)
- Minimizes HVAC during predicted high-cost periods
- Estimated daily cost: $11.67 for 60 kWh consumption

**Scenario 2: High Energy Cost (Real-time)**
- System stops EV charging when electricity is expensive
- Reduces lighting brightness
- Minimizes HVAC usage if temperature is acceptable

**Scenario 3: High Solar Production (Real-time)**
- Prioritizes energy-intensive tasks (EV charging, heating)
- Opens curtains to utilize solar heat
- Runs appliances on solar power

**Scenario 4: Temperature Control**
- Turns on heater when indoor temperature drops below target
- Activates AC when temperature exceeds target
- Closes curtains to block external heat

## Day-Ahead Schedule Example

```
Hour 0:00-6:00 (Night - Low Cost)
  - EV Charger: Defer (not optimal)
  - Heater: Preheat to 23°C (save on peak hours)

Hour 10:00-13:00 (Midday - High Solar)
  - EV Charger: Charge at 11kW (optimal hours)
  - Solar production: 6-8 kW available

Hour 7:00-22:00 (Day - High Cost)
  - HVAC: Minimize usage
  - Use preheated/cooled thermal mass
```

## Extensibility

The system is designed for easy extension:

### Adding New Sensors
1. Inherit from `Sensor` base class
2. Implement `update()` method
3. Publish events using `publishEvent()`

### Adding New Appliances
1. Inherit from `Appliance` base class
2. Implement control methods (`turnOn()`, `turnOff()`)
3. Add to `EnergyOptimizer` for automated control

### Adding New Event Types
1. Add to `EventType` enum in `Event.h`
2. Subscribe to events in relevant components
3. Implement event handlers

### Improving ML Models
1. Add more features to `HistoricalDataPoint` (humidity, occupancy, etc.)
2. Implement advanced algorithms in `MLPredictor` (neural networks, ensemble methods)
3. Integrate with real ML libraries (TensorFlow, PyTorch)
4. Add model persistence for continuous learning

## Configuration

The system includes a comprehensive configuration management system with a web-based interface:

**[CONFIG_SYSTEM.md](CONFIG_SYSTEM.md)** - Complete configuration system guide:
- Config class for managing system settings
- Web interface for easy configuration (accessible at http://localhost:8080)
- Configure deferrable loads, MQTT settings, and sensors
- REST API for programmatic configuration
- Persistent configuration storage in JSON format
- Real-time configuration updates

The system can also be configured programmatically by:
- Adjusting thresholds in `EnergyOptimizer` (cost thresholds, temperature targets)
- Setting `evChargingHoursNeeded_` in `DayAheadOptimizer`
- Training ML model with more historical data
- Modifying MQTT broker address
- Changing HTTP API endpoint
- Adding/removing sensors and appliances

## Production Deployment

For production use, integrate:
- **Configuration System**: Web-based configuration interface (see [CONFIG_SYSTEM.md](CONFIG_SYSTEM.md))
- **MQTT Library**: Eclipse Paho MQTT or mosquitto (see [MQTT_MOSQUITTO_GUIDE.md](MQTT_MOSQUITTO_GUIDE.md) for integration instructions)
- **Home Assistant**: Connect to real HA instance via MQTT (see [HA_MQTT_INTEGRATION.md](HA_MQTT_INTEGRATION.md) for complete guide)
- **HTTP Library**: libcurl or cpp-httplib
- **Database**: Store historical data and analytics
- **Web Interface**: Built-in configuration web interface or custom control panel for monitoring
- **Security**: TLS/SSL for MQTT and HTTP communications, authentication for web interface

### MQTT Integration with Mosquitto

The current `MQTTClient` uses a mock implementation for simulation. To integrate with a real MQTT broker using the Eclipse Mosquitto library, see the comprehensive guide:

**[MQTT_MOSQUITTO_GUIDE.md](MQTT_MOSQUITTO_GUIDE.md)** - Complete guide with:
- Installation instructions for mosquitto library and broker
- Integration approaches (wrapper vs direct usage)
- Example code for production deployment
- MQTT topics structure and message formats
- Broker configuration (basic and secure)
- Authentication and TLS/SSL setup
- Testing with mosquitto clients
- Troubleshooting tips

### Home Assistant MQTT Integration

The system now includes full bidirectional integration with Home Assistant via MQTT:

**[HA_MQTT_INTEGRATION.md](HA_MQTT_INTEGRATION.md)** - Complete guide with:
- Fetching sensor data FROM Home Assistant via MQTT subscribe
- Executing commands TO Home Assistant via MQTT publish
- Home Assistant MQTT discovery protocol support
- Complete usage examples and API reference
- HA configuration examples for sensors, switches, lights
- Testing procedures with real Home Assistant
- Troubleshooting and best practices

**[SENSOR_STATE_PUBLISHING.md](SENSOR_STATE_PUBLISHING.md)** - Publishing sensor states guide:
- How to publish ALL local sensor states to MQTT/Home Assistant
- Automatic sensor registration using MQTT discovery
- Publishing sensor states with attributes (units, friendly names)
- Automatic publishing on sensor updates
- Complete working examples and MQTT topic structure
- Home Assistant configuration for receiving sensor data
- Testing with MQTT command-line tools

### Home Assistant REST API Integration

The system includes comprehensive REST API support for extracting sensor data:

**[HA_REST_API_GUIDE.md](HA_REST_API_GUIDE.md)** - Complete REST API guide with:
- How to extract sensor data from Home Assistant using RESTful API
- Authentication setup with long-lived access tokens
- Complete API endpoint documentation
- Working code examples in C++, Python, JavaScript, and Bash
- Getting single sensor states and all sensors
- Retrieving historical data from the database
- Controlling devices via service calls
- Error handling and best practices
- Production deployment guidelines
- Security considerations and troubleshooting

**[examples/](examples/)** - Working code examples:
- **[ha_rest_curl_example.cpp](examples/ha_rest_curl_example.cpp)** - Complete libcurl example demonstrating REST API usage
- Ready to compile and run with your Home Assistant instance
- Includes connection testing, sensor queries, historical data retrieval, and service calls
- See [examples/README.md](examples/README.md) for build instructions

### Deferrable Load Control

The system includes intelligent control of non-critical loads based on energy prices:

**[DEFERRABLE_LOAD_CONTROL.md](DEFERRABLE_LOAD_CONTROL.md)** - Complete deferrable load control guide:
- How to classify loads as deferrable or non-deferrable
- Price threshold-based automatic control
- Historical data analysis for busy hour identification
- Day-ahead recommendations for load scheduling
- Integration with ML-based day-ahead optimizer
- API reference and usage examples
- Production deployment guidelines
- Cost savings analysis and benefits

### Continuous ML Training

The system supports continuous learning from operational data:

**[CONTINUOUS_TRAINING.md](CONTINUOUS_TRAINING.md)** - Continuous ML training guide:
- How to continuously update historical data during operation
- Automatic ML predictor retraining on schedule
- Data persistence and retention management
- Real-time data collection from sensors
- Configuration options and best practices
- Integration examples with existing components
- API reference for HistoricalDataCollector and MLTrainingScheduler
- Complete test program demonstrating all features

**Use Cases:**
- **REST API**: Initial state synchronization, historical data, one-time queries
- **MQTT**: Real-time updates, event-driven automation, efficient continuous monitoring
- **Continuous Training**: Model improvement over time, adaptation to usage patterns
- **Recommendation**: Use all three for a robust, learning system!

## License

This is a demonstration project for home automation system design.
